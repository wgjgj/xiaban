<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>ç‰›é©¬å€’è®¡æ—¶ Â· å¼¹å¹•è”æœºç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{
    margin:0;
    height:100%;
    background:#1f1f1f;
    font-family:"Microsoft YaHei",sans-serif;
    overflow:hidden;
}
.wrap{
    position:relative;
    z-index:2;
    height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    color:#e6e6e6;
    pointer-events: none; /* é˜²æ­¢é®æŒ¡å¼¹å¹•ç‚¹å‡»/è¾“å…¥ */
}
h1{letter-spacing:3px;margin-bottom:4px}
.subtitle{font-size:13px;color:#aaa;margin-bottom:18px}
.time{font-size:40px;font-weight:bold}
.desc{margin-top:8px;font-size:15px;color:#999}

/* æ‹‰ç£¨ */
.mill-area{position:relative;width:320px;height:320px;margin-top:26px}
.mill{
    position:absolute;
    left:50%;top:50%;
    width:190px;height:190px;
    margin:-95px;
    border-radius:50%;
    border:6px dashed #555;
}
.animal{
    position:absolute;
    left:50%;top:50%;
    width:58px;height:58px;
    margin:-29px;
    animation:walk 10s linear infinite;
    filter:grayscale(1);
}
@keyframes walk{
    from{transform:rotate(0deg) translateX(150px)}
    to{transform:rotate(360deg) translateX(150px)}
}

/* å¼¹å¹•ï¼šæ”¾å¤§å­—ä½“ã€å›ºå®šè¡Œé«˜ã€ä¸é‡å æ ¸å¿ƒæ ·å¼ */
.bubble{
    position:absolute;
    white-space:nowrap;
    color:#e6e6e6;
    font-size:18px;
    font-weight:500;
    z-index:5;
    line-height:40px; /* åŠ å¤§è¡Œé«˜ï¼Œè¿›ä¸€æ­¥é˜²æ­¢è¦†ç›– */
    height:40px;
    transform: translateY(-50%); /* å‚ç›´å±…ä¸­ï¼Œè§†è§‰æ›´èˆ’é€‚ */
    /* é»˜è®¤é€æ˜åº¦ï¼Œä¼šè¢«JSåŠ¨æ€è¦†ç›– */
    opacity: 1;
}
/* æ— é™æ»šåŠ¨åŠ¨ç”»ï¼šå®Œæ•´æ»šå…¥æ»šå‡ºï¼Œæ— é—´æ–­ */
@keyframes danmuMove{
    0%{transform: translateX(100vw) translateY(-50%);}
    100%{transform: translateX(-100%) translateY(-50%);}
}

/* è¾“å…¥æ¡†ï¼šä¼˜åŒ–æ ·å¼ï¼Œæé«˜å±‚çº§ */
.input-box{
    position:fixed;
    bottom:18px;
    left:50%;
    transform:translateX(-50%);
    z-index:999; /* æœ€é«˜å±‚çº§ï¼Œä¸è¢«é®æŒ¡ */
    display:flex;
    gap:8px;
}
.input-box input{
    padding:10px 12px;
    width:260px; /* åŠ å®½è¾“å…¥æ¡† */
    font-size:16px;
    border:1px solid #444;
    background:#2f2f2f;
    color:#e6e6e6;
    border-radius:4px;
    outline:none;
}
.input-box input::placeholder{
    color:#888;
}
.input-box button{
    padding:10px 20px;
    cursor:pointer;
    border:none;
    background:#666;
    color:#fff;
    border-radius:4px;
    transition:background 0.2s;
}
.input-box button:hover{
    background:#888;
}

/* ç°å°˜ */
canvas#dust{
    position:absolute;
    left:0;top:0;
    width:100%;height:100%;
    z-index:1;
    pointer-events: none;
}
</style>
</head>

<body>

<div class="wrap">
    <h1>ğŸ‚ ç‰›é©¬å€’è®¡æ—¶</h1>
    <div class="subtitle">åŠªåŠ›ä¸ä¸€å®šæœ‰ç»“æœï¼Œä½†ä¸€å®šå¾ˆç´¯</div>
    <div class="time" id="time">00 å¤© 00:00:00</div>
    <div class="desc" id="desc">ä»Šå¤©ä¹Ÿåœ¨æ­£å¸¸è¿è½¬</div>

    <div class="mill-area">
        <div class="mill"></div>
        <svg class="animal" viewBox="0 0 100 100">
            <g fill="#666">
                <ellipse cx="50" cy="55" rx="26" ry="18"/>
                <circle cx="78" cy="50" r="6"/>
                <rect x="20" y="68" width="6" height="18"/>
                <rect x="36" y="68" width="6" height="18"/>
                <rect x="56" y="68" width="6" height="18"/>
                <rect x="72" y="68" width="6" height="18"/>
            </g>
        </svg>
    </div>
</div>

<div class="input-box">
    <input id="danmuInput" placeholder="å‘ä¸€å¥ç‰›é©¬å®£è¨€â€¦" autocomplete="off">
    <button onclick="sendDanmu()">å‘å°„</button>
</div>

<canvas id="dust"></canvas>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/******** Firebase é…ç½®ï¼ˆâš ï¸ å¿…é¡»æ¢æˆä½ è‡ªå·±çš„ï¼‰ ********/
const firebaseConfig = {
  apiKey: "AIzaSyBAo6VlGLletfeDlAjdcfwARnieYdQNOMU",
  authDomain: "xiaban-bb95e.firebaseapp.com",
  databaseURL: "https://xiaban-bb95e-default-rtdb.firebaseio.com",
  projectId: "xiaban-bb95e",
};

// Firebaseåˆå§‹åŒ–é”™è¯¯å¤„ç†
try {
    firebase.initializeApp(firebaseConfig);
} catch (error) {
    console.error("Firebaseåˆå§‹åŒ–å¤±è´¥ï¼š", error);
    alert("å¼¹å¹•è”æœºåŠŸèƒ½å¤±æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®æˆ–ç½‘ç»œï½");
}
const db = firebase.database();
const danmuRef = db.ref("danmu");
const ONE_HOUR = 60 * 60 * 1000;
// æ–°å¢ï¼šå¼¹å¹•è¡°å‡é…ç½®ï¼ˆå¯è°ƒæ•´ï¼‰
const DANMU_FADE_CONFIG = {
    fadeDuration: 5 * 60 * 1000, // 5åˆ†é’Ÿå†…é€æ¸å˜æ·¡ï¼ˆæ¯«ç§’ï¼‰
    minOpacity: 0.3, // æœ€å°é€æ˜åº¦
    maxOpacity: 1.0  // æœ€å¤§é€æ˜åº¦
};
    
/******** åŠ¨æ€è®¡ç®—æ¯æ—¥ç›®æ ‡æ—¶é—´ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰ ********/
// è·å–å½“å¤©/æ¬¡æ—¥18:15çš„æ—¶é—´å¯¹è±¡
function getTargetTime() {
    const now = new Date();
    // åˆ›å»ºå½“å¤©18:15çš„æ—¶é—´
    const target = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        18, // å°æ—¶
        15, // åˆ†é’Ÿ
        0,  // ç§’
        0   // æ¯«ç§’
    );
    
    // å¦‚æœå½“å‰æ—¶é—´å·²ç»è¿‡äº†18:15ï¼Œåˆ™ç›®æ ‡æ—¶é—´æ”¹ä¸ºæ˜å¤©çš„18:15
    if (now > target) {
        target.setDate(target.getDate() + 1);
    }
    
    return target;
}

/******** å€’è®¡æ—¶ï¼ˆä¿®æ”¹ä¸ºåŠ¨æ€æ›´æ–°ç›®æ ‡æ—¶é—´ï¼‰ ********/
function update(){
    const now = new Date();
    const targetDate = getTargetTime(); // æ¯æ¬¡æ›´æ–°éƒ½é‡æ–°è®¡ç®—ç›®æ ‡æ—¶é—´
    let diff = targetDate - now;

    if(diff <= 0){
        document.getElementById('time').innerText = "å·²å®Œæˆä»Šæ—¥ä»»åŠ¡";
        document.getElementById('desc').innerText = "æ˜å¤©ç»§ç»­åŠ æ²¹";
        return;
    }

    // è®¡ç®—æ—¶åˆ†ç§’ï¼ˆå› ä¸ºæ˜¯æ¯æ—¥ç›®æ ‡ï¼Œå¤©æ•°åªå¯èƒ½æ˜¯0æˆ–1ï¼‰
    const d = Math.floor(diff/86400000);
    const h = Math.floor(diff/3600000)%24;
    const m = Math.floor(diff/60000)%60;
    const s = Math.floor(diff/1000)%60;

    // æ ¹æ®å¤©æ•°æ˜¾ç¤ºä¸åŒæ–‡æ¡ˆï¼ˆ0å¤©åˆ™åªæ˜¾ç¤ºæ—¶åˆ†ç§’ï¼‰
    if (d === 0) {
        document.getElementById('time').innerText = 
            String(h).padStart(2,'0') + ":" +
            String(m).padStart(2,'0') + ":" +
            String(s).padStart(2,'0');
    } else {
        document.getElementById('time').innerText =
            d + " å¤© " +
            String(h).padStart(2,'0') + ":" +
            String(m).padStart(2,'0') + ":" +
            String(s).padStart(2,'0');
    }
}
setInterval(update,1000);update();

/******** å¼¹å¹•æ ¸å¿ƒé…ç½®ï¼šåˆ†æ‰¹å»¶è¿Ÿ+é˜²è¦†ç›–+é€Ÿåº¦ï¼ˆå¯ç›´æ¥ä¿®æ”¹ï¼‰ ********/
const danmuConfig = {
    lineHeight: 40,    // ä¸CSSä¸­bubbleçš„line-heightä¸€è‡´
    speed: 18,         // æ»šåŠ¨é€Ÿåº¦ï¼ˆç§’ï¼Œå€¼è¶Šå°è¶Šå¿«ï¼‰
    space: 200,        // åŒè¡ŒåŠ¨ç”»é—´éš”ï¼ˆåƒç´ ï¼‰
    maxLines: Math.floor(window.innerHeight / 40), // è‡ªåŠ¨è®¡ç®—æœ€å¤§è¡Œæ•°
    usedLines: new Map(), // è®°å½•è¡Œå·+æœ€åä¸€ä¸ªå¼¹å¹•çš„ç»“æŸä½ç½®
    batchInterval: 800, // åˆ†æ‰¹å»¶è¿Ÿé—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œæ¯800mså‡ºä¸€ä¸ªå¼¹å¹•
    danmuQueue: [],    // å¼¹å¹•ç­‰å¾…é˜Ÿåˆ—ï¼ˆç°åœ¨å­˜å‚¨å®Œæ•´å¯¹è±¡ï¼ŒåŒ…å«textå’Œtimeï¼‰
    isProcessingQueue: false // æ˜¯å¦æ­£åœ¨å¤„ç†é˜Ÿåˆ—
};

// çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—é…ç½®
window.addEventListener('resize', () => {
    danmuConfig.maxLines = Math.floor(window.innerHeight / danmuConfig.lineHeight);
    // è¶…å‡ºæœ€å¤§è¡Œæ•°åˆ™æ¸…ç©ºå†—ä½™è®°å½•
    for (let [line] of danmuConfig.usedLines) {
        if (line >= danmuConfig.maxLines) danmuConfig.usedLines.delete(line);
    }
});

/******** è®¡ç®—å¼¹å¹•é€æ˜åº¦ ********/
function calculateDanmuOpacity(createTime) {
    const now = Date.now();
    const diff = now - createTime;
    
    // å¦‚æœå¼¹å¹•åˆ›å»ºæ—¶é—´åœ¨è¡°å‡æ—¶é•¿å†…ï¼Œè®¡ç®—è¡°å‡åçš„é€æ˜åº¦
    if (diff < DANMU_FADE_CONFIG.fadeDuration) {
        // è®¡ç®—è¡°å‡æ¯”ä¾‹ï¼šä»1åˆ°minOpacityçº¿æ€§é€’å‡
        const ratio = 1 - (diff / DANMU_FADE_CONFIG.fadeDuration);
        return DANMU_FADE_CONFIG.minOpacity + (DANMU_FADE_CONFIG.maxOpacity - DANMU_FADE_CONFIG.minOpacity) * ratio;
    }
    // è¶…è¿‡è¡°å‡æ—¶é•¿ï¼Œä½¿ç”¨æœ€å°é€æ˜åº¦
    return DANMU_FADE_CONFIG.minOpacity;
}

/******** å¤„ç†å¼¹å¹•é˜Ÿåˆ—ï¼ˆæ ¸å¿ƒï¼šåˆ†æ‰¹å»¶è¿Ÿæ˜¾ç¤ºï¼‰ ********/
function processDanmuQueue() {
    // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºæˆ–æ­£åœ¨å¤„ç†ï¼Œç›´æ¥è¿”å›
    if (danmuConfig.danmuQueue.length === 0) {
        danmuConfig.isProcessingQueue = false;
        return;
    }

    danmuConfig.isProcessingQueue = true;
    // å–å‡ºé˜Ÿåˆ—ç¬¬ä¸€ä¸ªå¼¹å¹•æ˜¾ç¤ºï¼ˆç°åœ¨æ˜¯å®Œæ•´å¯¹è±¡ï¼‰
    const danmu = danmuConfig.danmuQueue.shift();
    spawnDanmu(danmu.text, danmu.time);

    // å»¶è¿ŸæŒ‡å®šæ—¶é—´åç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
    setTimeout(processDanmuQueue, danmuConfig.batchInterval);
}

/******** å¼¹å¹•å‘é€ï¼šç‚¹å‡»+å›è½¦é”® ********/
const danmuInput = document.getElementById('danmuInput');
// ç‚¹å‡»å‘é€
function sendDanmu(){
    if(!danmuInput.value.trim()) return;
    const nowTime = Date.now();
    // å†™å…¥Firebase
    danmuRef.push({
        text: danmuInput.value,
        time: nowTime
    });
    danmuInput.value="";
    danmuInput.focus(); // å‘é€åä¿æŒè¾“å…¥æ¡†èšç„¦ï¼Œæ–¹ä¾¿è¿ç»­å‘é€
}
// å›è½¦é”®å‘é€
danmuInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // é˜»æ­¢è¾“å…¥æ¡†æ¢è¡Œ
        sendDanmu();
    }
});

/******** æ¥æ”¶å¼¹å¹•ï¼šå†å²+å®æ—¶ï¼ˆåŠ å…¥é˜Ÿåˆ—ï¼Œåˆ†æ‰¹æ˜¾ç¤ºï¼‰ ********/
const now = Date.now();
// è¯»å–1å°æ—¶å†…å†å²å¼¹å¹•ï¼ˆåŠ å…¥é˜Ÿåˆ—ï¼‰
danmuRef.once("value", snapshot => {
    snapshot.forEach(child => {
        const data = child.val();
        if (now - data.time <= ONE_HOUR) {
            // é˜Ÿåˆ—å­˜å‚¨å®Œæ•´å¯¹è±¡ï¼ŒåŒ…å«textå’Œtime
            danmuConfig.danmuQueue.push({
                text: data.text,
                time: data.time
            });
        }
    });
    // å¼€å§‹å¤„ç†å†å²å¼¹å¹•é˜Ÿåˆ—
    processDanmuQueue();
});

// ç›‘å¬å®æ—¶æ–°å¢å¼¹å¹•ï¼ˆåŠ å…¥é˜Ÿåˆ—ï¼‰
danmuRef.on("child_added", snap => {
    const data = snap.val();
    if (Date.now() - data.time <= ONE_HOUR) {
        // é˜Ÿåˆ—å­˜å‚¨å®Œæ•´å¯¹è±¡ï¼ŒåŒ…å«textå’Œtime
        danmuConfig.danmuQueue.push({
            text: data.text,
            time: data.time
        });
        // å¦‚æœæ²¡æœ‰åœ¨å¤„ç†é˜Ÿåˆ—ï¼Œå°±å¼€å§‹å¤„ç†
        if (!danmuConfig.isProcessingQueue) {
            processDanmuQueue();
        }
    }
});

/******** å¼¹å¹•ç”Ÿæˆï¼šé˜²è¦†ç›–æ ¸å¿ƒé€»è¾‘ + é¢œè‰²è¡°å‡ ********/
function spawnDanmu(text, createTime){
    const t = document.createElement('div');
    t.className = 'bubble';
    t.innerText = text;
    
    // è®¡ç®—å¹¶è®¾ç½®å¼¹å¹•é€æ˜åº¦
    const opacity = calculateDanmuOpacity(createTime);
    t.style.opacity = opacity;
    
    document.body.appendChild(t);

    // 1. è·å–å¼¹å¹•å®é™…å®½åº¦ï¼ˆå¿…é¡»æ¸²æŸ“åæ‰èƒ½è·å–ï¼‰
    const danmuWidth = t.offsetWidth;
    // å±å¹•å®½åº¦
    const screenWidth = window.innerWidth;

    // 2. æ ¸å¿ƒï¼šåˆ†é…ç©ºé—²è¡Œï¼ˆåŒè¡ŒåŠ¨ç”»é—´éš”è¶³å¤Ÿæ‰åˆ†é…ï¼‰
    let targetLine = -1;
    for (let i = 0; i < danmuConfig.maxLines; i++) {
        // è·å–è¯¥è¡Œæœ€åä¸€ä¸ªå¼¹å¹•çš„ç»“æŸä½ç½®ï¼Œé»˜è®¤0
        const lastEndX = danmuConfig.usedLines.get(i) || 0;
        // å½“å‰æ—¶é—´çš„å±å¹•å³ä¾§ä½ç½® - é—´éš” > ä¸Šä¸€ä¸ªå¼¹å¹•ç»“æŸä½ç½® â†’ è¯¥è¡Œç©ºé—²
        if (screenWidth - danmuConfig.space > lastEndX) {
            targetLine = i;
            break;
        }
    }
    // è‹¥æ— å®Œå…¨ç©ºé—²è¡Œï¼Œæ‰¾â€œæœ€ç©ºé—²â€çš„è¡Œï¼ˆæœ€åä¸€ä¸ªå¼¹å¹•ç»“æŸä½ç½®æœ€å°ï¼‰
    if (targetLine === -1) {
        let minEndX = Infinity;
        for (let [line, endX] of danmuConfig.usedLines) {
            if (endX < minEndX) {
                minEndX = endX;
                targetLine = line;
            }
        }
        // å…œåº•ï¼šéšæœºåˆ†é…ï¼ˆé˜²æ­¢æç«¯æƒ…å†µï¼‰
        if (targetLine === -1) targetLine = Math.floor(Math.random() * danmuConfig.maxLines);
    }

    // 3. è®¡ç®—å½“å‰å¼¹å¹•çš„ç»“æŸä½ç½®ï¼ˆå±å¹•å®½åº¦ + å¼¹å¹•å®½åº¦ï¼‰
    const currentEndX = screenWidth + danmuWidth;
    // æ›´æ–°è¯¥è¡Œçš„æœ€åç»“æŸä½ç½®
    danmuConfig.usedLines.set(targetLine, currentEndX);

    // 4. è®¾ç½®å¼¹å¹•ä½ç½®
    const top = (targetLine + 0.5) * danmuConfig.lineHeight; // å‚ç›´å±…ä¸­
    t.style.top = `${top}px`;

    // 5. è®¾ç½®æ— é™æ»šåŠ¨åŠ¨ç”»
    const animateTime = `${danmuConfig.speed}s`;
    t.style.animation = `danmuMove ${animateTime} linear infinite`;

    // 6. åŠ¨ç”»å¾ªç¯å›è°ƒï¼šæ›´æ–°è¯¥è¡Œæœ€åç»“æŸä½ç½®ï¼ˆæ ¸å¿ƒï¼Œä¿æŒåŒè¡ŒåŠ¨ç”»é—´éš”ï¼‰
    t.addEventListener('animationiteration', () => {
        danmuConfig.usedLines.set(targetLine, screenWidth + danmuWidth);
    });

    // 7. å…œåº•ï¼šå…ƒç´ ç§»é™¤æ—¶æ¸…ç†ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
    t.addEventListener('remove', () => {
        // è‹¥è¯¥è¡Œåªæœ‰å½“å‰å¼¹å¹•ï¼Œåˆ é™¤è®°å½•
        if (danmuConfig.usedLines.get(targetLine) === currentEndX) {
            danmuConfig.usedLines.delete(targetLine);
        }
    });
}

/******** ç°å°˜åŠ¨æ•ˆï¼šé€‚é…çª—å£ ********/
const c = document.getElementById('dust');
const ctx = c.getContext('2d');
c.width = innerWidth;
c.height = innerHeight;
let dusts = [];
for(let i=0;i<120;i++){
    dusts.push({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*2+0.5,v:Math.random()*0.3});
}
function animate(){
    ctx.clearRect(0,0,c.width,c.height);
    ctx.fillStyle='rgba(180,180,180,0.25)';
    dusts.forEach(p=>{
        p.x+=p.v;if(p.x>c.width)p.x=0;
        ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
    });
    requestAnimationFrame(animate);
}
animate();
// ç°å°˜ç”»å¸ƒé€‚é…çª—å£
window.addEventListener('resize', () => {
    c.width = window.innerWidth;
    c.height = window.innerHeight;
});
</script>

</body>
</html>
